<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
</head>

<body>
    <script>
    // JPS commit comment
        
    class Player{
        constructor(x, y, scene, n, direction){
            this.player = scene.physics.add.sprite(x, y, direction);
            this.player.setVelocity(0, 0);
            this.player.setBounce(0, 0);
            this.player.setCollideWorldBounds(true);
            this.player.setScale(3.4);
            this.player.body.setSize(9, 24, 4.5, 12);
                                
            this.kickHitBox = scene.physics.add.sprite(this.player.x, this.player.y, null);
            this.kickHitBox.setVisible(false); // Make the hitbox invisible
            this.kickHitBox.setSize(50, 50); // Set the size of the hitbox
            this.kickHitBox.setVelocity(0, 0); // Set the velocity of the hitbox
            this.lastKickTime = 0;
            this.num = n;
            
            this.score = 0;
        }
        
        update(up, left, down, right){

                //Slowdown when not pressing anything or pressing oposite movement
                if (left.isDown && right.isDown || !left.isDown && !right.isDown) {

                    if (this.player.body.blocked.down) {
                        this.player.setVelocityX(this.player.body.velocity.x * .7);
                    }
                    else {
                        this.player.setVelocityX(this.player.body.velocity.x * .9);
                    }

                }

                else if (left.isDown) {
                    this.player.setTexture('BlueLeft');
                    //Move slower in the air
                    if (!this.player.body.blocked.down) {
                        this.player.setVelocityX(this.player.body.velocity.x - 20);
                    }
                    else {
                        this.player.setVelocityX(this.player.body.velocity.x - 70);
                    }


                }
                else if (right.isDown) {
                    this.player.setTexture('BlueRight');

                    if (!this.player.body.blocked.down) {
                        this.player.setVelocityX(this.player.body.velocity.x + 20);
                    }
                    else {
                        this.player.setVelocityX(this.player.body.velocity.x + 70);
                    }
                }

                //Jump
                if (up.isDown && this.player.body.blocked.down) {
                    this.player.setVelocityY(-500)
                }


            //Max horizontal speed
            if(Math.abs(this.player.body.velocity.x) > 500){
                this.player.setVelocityX(500 * Math.sign(this.player.body.velocity.x));
            }
            
            this.kickHitBox.x = this.player.x;
            this.kickHitBox.y = this.player.y;
            this.kickHitBox.setVelocityX(0);
            this.kickHitBox.setVelocityY(0);

        
        }
        
        getSprite(){
            return this.player;
        }
        
        getX(){
            return this.player.x;
        }
        
        getY(){
            return this.player.y;
        }
        
        getVelocityX(){
            return this.player.body.velocity.x;
        }
        
        getVelocityY(){
            return this.player.body.velocity.y;
        }
        
        getWidth(){
            return this.player.body.width;
        }
        
        getHeight(){
            return this.player.body.height;
        }

            getLastKickTime() {
                return this.lastKickTime;
            }

            getHeight() {
                return this.player.body.height;
            }

            getWidth() {
                return this.player.body.height;
            }

            setLastKickTime(n) {
                this.lastKickTime = n;
            }

            increaseScore() {
                this.score++;
            }

            setX(n) {
                this.player.x = n;
            }

        setY(n){
            this.player.y = n;
        }
        
        
        
    }
        
    class Ball{
        constructor(x, y, scene){
            this.ball = scene.physics.add.sprite(x, y, 'SoccerBall');
            this.ball.setScale(2.2);
            this.ball.setBounce(1);
            this.ball.setCollideWorldBounds(true);
            this.ball.body.setCircle(12.5);
        }
        
        update(){
            
            if(Math.abs(this.ball.body.velocity.x) > 700){
                this.ball.setVelocityX(700 * Math.sign(this.ball.body.velocity.x));
            }
            if(Math.abs(this.ball.body.velocity.y) > 700){
                this.ball.setVelocityY(700 * Math.sign(this.ball.body.velocity.y))
            }

            //Add friction to the ball
            if(this.ball.body.blocked.down){
                this.ball.setVelocityX(this.ball.body.velocity.x * .7);
                this.ball.setVelocityY(this.ball.body.velocity.y * .7);
            }
            else if(this.ball.body.blocked.left || this.ball.body.blocked.right){
                this.ball.setVelocityX(this.ball.body.velocity.x * .7);
                this.ball.setVelocityY(this.ball.body.velocity.y * .7);
            }
            else{
                //ball.setVelocityX(ball.body.velocity.x * .9);
                //ball.setVelocityY(ball.body.velocity.y * .9);
            }

                //Ball will always bounce
                if (this.ball.body.blocked.down && Math.abs(this.ball.body.velocity.y) < 400) {
                    this.ball.setVelocityY(-400);
                }
            }

            getSprite() {
                return this.ball;
            }

            getX() {
                return this.ball.x;
            }

            getY() {
                return this.ball.y;
            }

            getVelocityX() {
                return this.ball.body.velocity.x;
            }

            getVelocityY() {
                return this.ball.body.velocity.y;
            }

            getWidth() {
                return this.ball.body.width;
            }

            getHeight() {
                return this.ball.body.height;
            }

            setVelocityX(velX) {
                this.ball.setVelocityX(velX);
            }

            setVelocityY(velY) {
                this.ball.setVelocityY(velY);
            }

            setX(n) {
                this.ball.x = n;
            }

            setY(n) {
                this.ball.y = n;
            }


        }

        class Goal {
            constructor(x, y, sprite, scene) {
                this.goal = scene.physics.add.sprite(x, y, sprite);
                this.goal.body.setAllowGravity(false);
                this.goal.setScale(1);
            }

            getSprite() {
                return this.goal;
            }

            getHeight() {
                return this.goal.body.height;
            }

            getWidth() {
                return this.goal.body.height;
            }

            getX() {
                return this.goal.x;
            }

            getY() {
                return this.goal.y;
            }
        }

        class Wall {
            constructor(x, y, width, height, color, scene) {
                // Create a graphics object
                let graphics = scene.make.graphics();

                // Draw a rectangle on the graphics object
                graphics.fillStyle(color);
                graphics.fillRect(0, 0, width, height);

                // Generate a texture from the graphics object
                let textureKey = 'wallTexture' + x + y;
                graphics.generateTexture(textureKey, width, height);

                // Create a physics object using the generated texture
                this.wall = scene.physics.add.staticImage(x, y, textureKey);
            }

            getSprite() {
                return this.wall;
            }
        }




        class BaseScene extends Phaser.Scene {

            soccerBall;
            cursors;
            keys;
            playerFacing;
            playerOne;
            facingLeft;
            facingRight;
            leftGoal;
            rightGoal;
            scoreText;
            walls;

            startTime;


            preload() {
                this.load.image('BlueRight', 'Sprites/Soccer_Blue-1.png');
                this.load.image('BlueLeft', 'Sprites/Soccer_Blue-2.png');
                this.load.image('SoccerBall', 'Sprites/Soccer_Ball-1.png');
                this.load.image('Background', 'Sprites/Background.png');
                this.load.image('RightGoal', 'Sprites/Right_Goal.png');
                this.load.image('LeftGoal', 'Sprites/Left_Goal.png');

            }

            create() {
                let background = this.add.image(1152 / 2, 648 / 2, 'Background');
                background.setScale(.6);



                // Create playerOne instance of Player class
                this.playerOne = new Player(config.width * .75, 100, this, 1, 'BlueLeft');
                this.playerTwo = new Player(config.width / 4, 100, this, 2, 'BlueRight');
                this.soccerBall = new Ball(config.width / 2, 0, this);
                this.leftGoal = new Goal(30, 600, 'LeftGoal', this);
                this.rightGoal = new Goal(config.width - 30, 600, 'RightGoal', this);
                this.walls = [];
                this.startTime = this.time.now;
                this.gameOver = false;

                //Ball collsion with player one
                this.physics.add.collider(this.playerOne.getSprite(), this.soccerBall.getSprite(), function (player, ball) { }, function (player, ball) {this.calculateCollision(this.playerOne, this.soccerBall, 1, this); return false; }, this);

                //Ball collision with player two
                this.physics.add.collider(this.playerTwo.getSprite(), this.soccerBall.getSprite(), function (player, ball) { }, function (player, ball) {this.calculateCollision(this.playerTwo, this.soccerBall, 2, this); return false; }, this);

                //Ball collision with the goals
                this.physics.add.collider(this.leftGoal.getSprite(), this.soccerBall.getSprite(), function (goal, ball) { }, function (goal, ball) {
                    if (Math.abs(this.soccerBall.getX() - this.leftGoal.getX()) < 10) {
                        ball.setX(config.width / 2);
                        ball.setY(0);
                        ball.setVelocityX(0);
                        ball.setVelocityY(0);
                        this.playerTwo.increaseScore();
                        this.playerOne.setX(config.width * .75);
                        this.playerOne.setY(config.height);
                        this.playerTwo.setX(config.width / 4);
                        this.playerTwo.setY(config.height);
                        this.playerTwoScoreText.setText('Player 2 score: ' + this.playerTwo.score);
                    }
                    return false;
                }, this);

                this.physics.add.collider(this.rightGoal.getSprite(), this.soccerBall.getSprite(), function (goal, ball) { }, function (goal, ball) {
                    if (Math.abs(this.soccerBall.getX() - this.rightGoal.getX()) < 10) {
                        ball.setX(config.width / 2);
                        ball.setY(0);
                        ball.setVelocityX(0);
                        ball.setVelocityY(0);
                        this.playerOne.increaseScore();
                        this.playerOne.setX(config.width * .75);
                        this.playerOne.setY(config.height);
                        this.playerTwo.setX(config.width / 4);
                        this.playerTwo.setY(config.height);
                        this.playerOneScoreText.setText('Player 1 score: ' + this.playerOne.score);
                    }
                    return false;
                }, this);

                //Add collision between the ball and the walls and the player and the walls
                for (this.i = 0; this.i < this.walls.length;this.i++) {
                    this.physics.add.collider(playerOne.getSprite(), walls[i].getSprite());
                    this.physics.add.collider(playerTwo.getSprite(), walls[i].getSprite());
                    this.physics.add.collider(soccerBall.getSprite(), walls[i].getSprite());
                }

                this.cursors = this.input.keyboard.createCursorKeys();
                this.keys = this.input.keyboard.addKeys('W, A, S, D');

                this.playerOneScoreText = this.add.text(100, 30, 'Player 1 score: 0', { fontSize: '25px', fill: '#000' });
                this.playerTwoScoreText = this.add.text(config.width / 2 + 100, 30, 'Player 2 score: 0', { fontSize: '25px', fill: '#000' });
                this.timerText = this.add.text(config.width / 2 - 50 , 30, 'Time: ', {fontSize: '25px', fill: '#000'})
            }


            //Calculates the collsion with the player and the ball
            calculateCollision(player, ball, playerNum, scene) {
                let currentTime = scene.time.now;
                // Check if enough time has passed since the last kick
                if (currentTime - player.getLastKickTime() < 200) {
                    // If not, return immediately without kicking
                    return;
                }

                //Kick code 
                //Player should kick when ever the player moves into the ball
                //If not the Idle Touch code should run

                //Up and left kick
                if (playerNum === 1 && this.cursors.up.isDown && this.cursors.left.isDown && ball.getX() - player.getX() <= 0 || playerNum === 2 && this.keys.W.isDown && this.keys.A.isDown && ball.getX() - player.getX() <= 0) {
                    ball.setVelocityY(-700);
                    ball.setVelocityX(- 90 - (Math.abs(player.getVelocityX())));
                    player.setLastKickTime(currentTime);
                }

                //Up and right kick
                else if (playerNum === 1 && this.cursors.up.isDown && this.cursors.right.isDown && ball.getX() - player.getX() > 0 || playerNum === 2 && this.keys.W.isDown && this.keys.D.isDown && ball.getX() - player.getX() > 0) {
                    ball.setVelocityY(-700);
                    ball.setVelocityX(90 + (Math.abs(player.getVelocityX())));
                    player.setLastKickTime(currentTime);
                }

                //Down and left kick
                else if (playerNum === 1 && this.cursors.down.isDown && this.cursors.left.isDown && ball.getY() - player.getY() <= 0 && !player.getSprite().body.blocked.down || playerNum === 2 && this.keys.S.isDown && this.keys.A.isDown && ball.getY() - player.getY() <= 0 && !player.getSprite().body.blocked.down ) {
                    ball.setVelocityY(700);
                    ball.setVelocityX(- 90 - (Math.abs(player.getVelocityX())));
                    player.setLastKickTime(currentTime);
                    console.log("DOWN LEFT");
                }

                //Down and right kick
                else if (playerNum === 1 && this.cursors.down.isDown && this.cursors.right.isDown && ball.getY() - player.getY() > 0 && !player.getSprite().body.blocked.down || playerNum === 2 && this.keys.S.isDown && this.keys.D.isDown && ball.getY() - player.getY() > 0 && !player.getSprite().body.blocked.down) {
                    ball.setVelocityY(700);
                    ball.setVelocityX(90 + (Math.abs(player.getVelocityX())));
                    player.setLastKickTime(currentTime);
                }

                //Left straight kick
                else if (playerNum === 1 && this.cursors.left.isDown && ball.getX() - player.getX() <= 0 || playerNum === 2 && this.keys.A.isDown && ball.getX() - player.getX() <= 0 === true) {
                    ball.setVelocityX(-90 - (Math.abs(player.getVelocityX())));
                    player.setLastKickTime(currentTime);
                } 
                
                //Right straight kick
                else if (playerNum === 1 && this.cursors.right.isDown && ball.getX() - player.getX() > 0 || playerNum === 2 && this.keys.D.isDown && this.keys.D.isDown && ball.getX() - player.getX() > 0) {
                    ball.setVelocityX(90 + (Math.abs(player.getVelocityX()))); 
                    player.setLastKickTime(currentTime);
                }
                
                //Up kick
                else if (playerNum === 1 && this.cursors.up.isDown || playerNum === 2 && this.keys.W.isDown) {
                    ball.setVelocityY(-90 - (Math.abs(player.getVelocityY() * 2)));
                    player.setLastKickTime(currentTime);
                }

                //Down kick
                else if (playerNum === 1 && this.cursors.down.isDown && !player.getSprite().body.blocked.down || playerNum === 2 && this.keys.S.isDown && !player.getSprite().body.blocked.down) {
                    ball.setVelocityY(90 + (Math.abs(player.getVelocityY() * 2)));
                    player.setLastKickTime(currentTime);
                }

                //Idle Touch


            }

            update() {
                console.log("Score: " + this.playerOne.score + " Score: " + this.playerTwo.score);
                //Movment & Controls
                this.playerOne.update(this.cursors.up, this.cursors.left, this.cursors.down, this.cursors.right);
                this.playerTwo.update(this.keys.W, this.keys.A, this.keys.S, this.keys.D);
                this.soccerBall.update();

                //Update timer to count down from 2:00 to 0
                let newTime = parseInt((121000 - (this.time.now - this.startTime)) / 1000);

                if(newTime % 60 <= 9 && newTime % 60 >= 0){
                    this.timerText.setText(parseInt(newTime / 60) + ':0' + newTime % 60);
                }
                else if (newTime % 60 > 9 && newTime >= 0){
                    this.timerText.setText(parseInt(newTime / 60) + ':' + newTime % 60);
                }
                else{
                    this.timerText.setText('0:00');
                }
                
                
                
            }
        }
    
        
        var config = {
            type: Phaser.AUTO,
            width: 1152,
            height: 648,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 1000 },
                    //debug: true
                }
            },
            scene: [BaseScene],
            pixelArt: true,
            roundPixels: true
        };

        var game = new Phaser.Game(config);


        /*
            class PowerUpsMode extends BaseScene
            {
                constructor() {
                    super({key: "PowerupScene"})
                }
                preload()
                {
                    super.preload();
                }
                create()
                {
        
                }
                update()
                {
        
                }
            }
        */



    </script>
</body>

</html>